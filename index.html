<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì—°ì œ ìš´ë™ ì²´í¬ ì•±</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#121212">
<link rel="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="icon-192.png">

<!-- Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
body { font-family:sans-serif; padding:15px; background:#121212; color:#e0e0e0; }
h2, h3 { text-align:center; color:#e0e0e0; }
.container { background:#1e1e1e; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.5); margin-bottom:15px; }
.save-btn, .delete-btn, .add-btn { padding:10px 15px; font-size:14px; border:none; border-radius:8px; cursor:pointer; }
.save-btn { background:#2a7bff; color:white; width:100%; margin-top:15px; }
.delete-btn { background:#d9534f; color:white; margin-left:10px; }
.add-btn { background:#ff9800; color:white; width:100%; margin-top:10px; }
.date-row { display:flex; align-items:center; }
.date-row input[type="text"] { flex:1; padding:8px; font-size:16px; background:#2c2c2c; color:#e0e0e0; border:1px solid #555; border-radius:5px; }
table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; border: 1px solid #555; border-radius: 10px; overflow: hidden; background:#1e1e1e; }
th, td { border: 1px solid #555; padding: 8px; text-align: center; color:#e0e0e0; }
th { background:#333; }
tr.draggable-row { cursor:move; }
tr.dragging { opacity:0.3; }
input[type="checkbox"] { width:18px; height:18px; accent-color:#2a7bff; }
footer { text-align:center; margin-top:20px; padding:10px; color:#888; }

/* ì§„ë„ìœ¨ ì›í˜• ê·¸ë˜í”„ */
#progressContainer { background:#1e1e1e; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.5); margin-bottom:15px; text-align:center; }
#progressPercent { color:#2a7bff; font-size:2em; font-weight:bold; margin-top:10px; }

/* Flatpickr ë‹¤í¬ëª¨ë“œ */
.flatpickr-calendar { background: #1e1e1e; color:#e0e0e0; border:1px solid #555; }
.flatpickr-day.selected { background:#2a7bff !important; color:#fff !important; }
.flatpickr-day.today { border-color:#2a7bff; }

/* ëª¨ë‹¬ */
.modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; justify-content:center; align-items:center; }
.modal { background:#2a2a2a; color:white; padding:20px; border-radius:10px; text-align:center; min-width:220px; }
.modal button { margin-top:10px; padding:5px 12px; border:none; border-radius:5px; background:#2a7bff; color:white; cursor:pointer; margin-right:5px;}
</style>
</head>
<body>

<h2>ì—°ì œ ìš´ë™ ì²´í¬ ì•±</h2>

<div id="progressContainer">
    <canvas id="progressCanvas" width="150" height="150"></canvas>
    <p id="progressPercent"></p>
</div>

<div class="container">
    <div class="date-row">
        <input type="text" id="dateInput" readonly />
        <button class="delete-btn" id="deleteBtn">ğŸ—‘ ì‚­ì œ</button>
    </div>

    <table id="exerciseTable">
        <thead>
            <tr><th>ìš´ë™</th><th>1set</th><th>2set</th><th>3set</th><th>ì‚­ì œ</th></tr>
        </thead>
        <tbody id="exerciseBody">
            <tr draggable="true" class="draggable-row"><td>ë³´ê°•</td><td><input type="checkbox" data-name="bo1"></td><td><input type="checkbox" data-name="bo2"></td><td><input type="checkbox" data-name="bo3"></td><td></td></tr>
            <tr draggable="true" class="draggable-row"><td>ì½”ì–´</td><td><input type="checkbox" data-name="core1"></td><td><input type="checkbox" data-name="core2"></td><td><input type="checkbox" data-name="core3"></td><td></td></tr>
            <tr draggable="true" class="draggable-row"><td>í‘¸ì‰¬ì—…</td><td><input type="checkbox" data-name="push1"></td><td><input type="checkbox" data-name="push2"></td><td><input type="checkbox" data-name="push3"></td><td></td></tr>
            <tr draggable="true" class="draggable-row"><td>ëª¸í†µ ëŒë¦¬ê¸°</td><td><input type="checkbox" data-name="bat1"></td><td><input type="checkbox" data-name="bat2"></td><td><input type="checkbox" data-name="bat3"></td><td></td></tr>
            <tr draggable="true" class="draggable-row"><td>ì•…ë ¥ê¸°</td><td><input type="checkbox" data-name="gripL"></td><td><input type="checkbox" data-name="gripR"></td><td></td><td></td></tr>
            <tr draggable="true" class="draggable-row"><td>ê³ ë¬´ì¤„ íŠœë¹™</td><td><input type="checkbox" data-name="tubing1"></td><td><input type="checkbox" data-name="tubing2"></td><td><input type="checkbox" data-name="tubing3"></td><td></td></tr>
        </tbody>
    </table>

    <button class="add-btn" id="addExerciseBtn">+ ìš´ë™ ì¶”ê°€</button>
    <button id="saveBtn" class="save-btn">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
</div>

<footer>ë§Œë“  ì‚¬ëŒ : <strong>Jaeho</strong></footer>

<!-- ëª¨ë‹¬ -->
<div id="modalOverlay" class="modal-overlay">
    <div class="modal" id="modalContent">
        <span id="modalMessage"></span><br>
        <button id="modalOkBtn">í™•ì¸</button>
        <button id="modalCancelBtn" style="display:none;">ì·¨ì†Œ</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
// ---------------- ëª¨ë‹¬ ----------------
const modalOverlay = document.getElementById("modalOverlay");
const modalMessage = document.getElementById("modalMessage");
const modalOkBtn = document.getElementById("modalOkBtn");
const modalCancelBtn = document.getElementById("modalCancelBtn");
function showAlert(msg){ modalMessage.textContent=msg; modalCancelBtn.style.display="none"; modalOverlay.style.display="flex"; }
function showConfirm(msg, okCallback){ modalMessage.textContent=msg; modalCancelBtn.style.display="inline-block"; modalOverlay.style.display="flex"; modalOkBtn.onclick=()=>{ modalOverlay.style.display="none"; okCallback(); }; modalCancelBtn.onclick=()=>{ modalOverlay.style.display="none"; }; }
modalOkBtn.onclick = ()=>{ modalOverlay.style.display="none"; };

// ---------------- Flatpickr ----------------
const exerciseBody = document.getElementById("exerciseBody");
const fp = flatpickr("#dateInput", {
    dateFormat: "Y-m-d",
    defaultDate: new Date(),
    onChange: function(selectedDates,dateStr){ loadData(dateStr); },
    onDayCreate: function(dObj,dStr,fpObj,dayElem){
        const date = dayElem.dateObj.toISOString().split("T")[0];
        if(localStorage.getItem("exercise_" + date)){ dayElem.classList.add("selected"); }
    },
    locale: "ko"
});

// ---------------- ìš´ë™ ì¶”ê°€/ì‚­ì œ ----------------
document.getElementById("addExerciseBtn").onclick = () => {
    const name = prompt("ì¶”ê°€í•  ìš´ë™ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:"); if(!name) return;
    const idBase=name.replace(/\s/g,"");
    const row=document.createElement("tr"); row.draggable=true; row.className="draggable-row";
    row.innerHTML=`<td>${name}</td><td><input type="checkbox" data-name="${idBase}_1"></td><td><input type="checkbox" data-name="${idBase}_2"></td><td><input type="checkbox" data-name="${idBase}_3"></td><td><button onclick="deleteRow(this)">X</button></td>`;
    exerciseBody.appendChild(row); initDragEvents();
};
function deleteRow(btn){ btn.closest("tr").remove(); }

// ---------------- ì €ì¥ ----------------
document.getElementById("saveBtn").onclick = ()=>{
    const key="exercise_"+fp.input.value;
    let data={};
    document.querySelectorAll("input[type=checkbox]").forEach(cb=>data[cb.dataset.name]=cb.checked);
    localStorage.setItem(key, JSON.stringify(data));
    showAlert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
    fp.redraw();
    updateMonthlyProgress();
};

// ---------------- ë¶ˆëŸ¬ì˜¤ê¸° ----------------
function loadData(date){
    document.querySelectorAll("input[type=checkbox]").forEach(cb=>cb.checked=false);
    const data=JSON.parse(localStorage.getItem("exercise_"+date)||"{}");
    for(let key in data){ const cb=document.querySelector(`[data-name="${key}"]`); if(cb) cb.checked=data[key]; }
}
loadData(fp.input.value);

// ---------------- ì‚­ì œ ----------------
document.getElementById("deleteBtn").onclick = ()=>{
    const date=fp.input.value;
    showConfirm(date + " ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?", ()=>{
        localStorage.removeItem("exercise_"+date);
        document.querySelectorAll("input[type=checkbox]").forEach(cb=>cb.checked=false);
        showAlert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!");
        fp.redraw(); updateMonthlyProgress();
    });
};

// ---------------- ë“œë˜ê·¸ ----------------
function initDragEvents(){
    const rows=document.querySelectorAll(".draggable-row");
    rows.forEach(row=>{ row.addEventListener("dragstart",()=>row.classList.add("dragging")); row.addEventListener("dragend",()=>row.classList.remove("dragging")); });
    exerciseBody.addEventListener("dragover", e=>{
        e.preventDefault();
        const dragging=document.querySelector(".dragging");
        const after=getDragAfterElement(exerciseBody,e.clientY);
        if(after==null) exerciseBody.appendChild(dragging); else exerciseBody.insertBefore(dragging, after);
    });
}
function getDragAfterElement(container,y){
    const elements=[...container.querySelectorAll(".draggable-row:not(.dragging)")];
    return elements.reduce((closest,child)=>{
        const box=child.getBoundingClientRect();
        const offset=y-box.top-box.height/2;
        if(offset<0 && offset>closest.offset) return {offset,element:child}; else return closest;
    }, {offset:Number.NEGATIVE_INFINITY}).element;
}
initDragEvents();

// ---------------- ì§„ë„ìœ¨ ì›í˜• ----------------
const canvas=document.getElementById("progressCanvas");
const ctx=canvas.getContext("2d");
function drawProgress(percent){
    const center=75, radius=70;
    ctx.clearRect(0,0,150,150);
    // ë°°ê²½ ì›
    ctx.beginPath(); ctx.arc(center,center,radius,0,2*Math.PI); ctx.strokeStyle="#555"; ctx.lineWidth=10; ctx.stroke();
    // ì§„í–‰ ì›
    ctx.beginPath(); ctx.arc(center,center,radius,-0.5*Math.PI,(percent/100)*2*Math.PI-0.5*Math.PI); ctx.strokeStyle="#2a7bff"; ctx.lineWidth=10; ctx.stroke();
    document.getElementById("progressPercent").textContent = percent.toFixed(1)+"%";
}

function updateMonthlyProgress(){
    const today=new Date();
    const year=today.getFullYear();
    const month=today.getMonth()+1;
    const totalDays=new Date(year,month,0).getDate();
    let completedDays=0;
    for(let i=1;i<=totalDays;i++){
        const day=i.toString().padStart(2,'0');
        const monthStr=month.toString().padStart(2,'0');
        const key=`exercise_${year}-${monthStr}-${day}`;
        if(localStorage.getItem(key)) completedDays++;
    }
    const progress=(completedDays/totalDays)*100;
    drawProgress(progress);
}
updateMonthlyProgress();

// ---------------- PWA ----------------
if('serviceWorker' in navigator){
    navigator.serviceWorker.register('service-worker.js')
    .then(()=>console.log('Service Worker ë“±ë¡ë¨'))
    .catch(err=>console.error('Service Worker ë“±ë¡ ì‹¤íŒ¨',err));
}
</script>

</body>
</html>
